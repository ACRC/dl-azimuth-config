#####
# This script activates the specified environment
#
# It needs to be sourced rather than just executed as it sets environment variables
# for the current shell
#####

if [ -z "$1" ]; then
    echo "Usage: source /path/to/activate [environment]" >&2
    return 1
fi

AZIMUTH_CONFIG_ENVIRONMENT="$1"
AZIMUTH_CONFIG_ROOT="$(dirname $(dirname $(realpath ${BASH_SOURCE[0]:-${(%):-%x}})))"
AZIMUTH_CONFIG_ENVIRONMENT_ROOT="$AZIMUTH_CONFIG_ROOT/environments/$AZIMUTH_CONFIG_ENVIRONMENT"

if [ ! -d "$AZIMUTH_CONFIG_ENVIRONMENT_ROOT" ]; then
    echo "Unrecognised environment" 2>&1
    return 1
fi

ANSIBLE_CONFIG="$AZIMUTH_CONFIG_ENVIRONMENT_ROOT/ansible.cfg"
if [ ! -f "$ANSIBLE_CONFIG" ]; then
    echo "Specified environment does not contain an ansible.cfg" 2>&1
    return 1
fi

# Only export the environment variables if the environment is a concrete environment
export \
  AZIMUTH_CONFIG_ENVIRONMENT \
  AZIMUTH_CONFIG_ROOT \
  AZIMUTH_CONFIG_ENVIRONMENT_ROOT \
  ANSIBLE_CONFIG

# Configure OpenStack connectivity
OS_CLIENT_CONFIG_FILE="$AZIMUTH_CONFIG_ENVIRONMENT_ROOT/clouds.yaml"
if [ -f "$OS_CLIENT_CONFIG_FILE" ]; then
  export OS_CLIENT_CONFIG_FILE
  export OS_CLOUD="openstack"
fi

# Source any variables from env files in the config root
if [ -f "$AZIMUTH_CONFIG_ROOT/env" ]; then
  set -a
  source "$AZIMUTH_CONFIG_ROOT/env" || return 1
  set +a
fi
if [ -f "$AZIMUTH_CONFIG_ROOT/env.secret" ]; then
  set -a
  source "$AZIMUTH_CONFIG_ROOT/env.secret" || return 1
  set +a
fi


# Also export any variables in env files in the environment
if [ -f "$AZIMUTH_CONFIG_ENVIRONMENT_ROOT/env" ]; then
  set -a
  source "$AZIMUTH_CONFIG_ENVIRONMENT_ROOT/env" || return 1
  set +a
fi
if [ -f "$AZIMUTH_CONFIG_ENVIRONMENT_ROOT/env.secret" ]; then
  set -a
  source "$AZIMUTH_CONFIG_ENVIRONMENT_ROOT/env.secret" || return 1
  set +a
fi

echo "Activated environment at $AZIMUTH_CONFIG_ENVIRONMENT_ROOT"
